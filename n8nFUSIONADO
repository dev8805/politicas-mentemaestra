{
  "name": "flujo_WHATSAPP3_fusionado",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "4ee1df92-7f87-454e-be06-e3ad837a105e",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [-1776, -16],
      "id": "5a2caa4a-bb16-47aa-9594-6b2e0de007a0",
      "name": "Webhook",
      "webhookId": "4ee1df92-7f87-454e-be06-e3ad837a105e"
    },
    {
      "parameters": {
        "operation": "get",
        "table": "conversaciones",
        "key": "telefono",
        "value": "={{$json[\"body\"][\"data\"][\"key\"][\"remoteJid\"]}}"
      },
      "name": "Leer estado",
      "type": "n8n-nodes-base.datastore",
      "typeVersion": 1,
      "position": [-1600, 200],
      "id": "leer_estado"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json[\"fase\"] || \"inicio\"}}",
              "operation": "equal",
              "value2": "inicio"
            }
          ]
        }
      },
      "name": "Switch fase",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [-1400, 200],
      "id": "switch_fase"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.data.messageType }}",
                    "rightValue": "audioMessage",
                    "operator": { "type": "string", "operation": "equals" }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "audio"
            },
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.data.messageType }}",
                    "rightValue": "conversation",
                    "operator": { "type": "string", "operation": "equals" }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "texto"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [-1552, -16],
      "id": "909e985c-b686-437d-9321-62b5ee72ed4d",
      "name": "Switch2"
    },
    {
      "parameters": {
        "resource": "chat-api",
        "operation": "get-media-base64",
        "instanceName": "={{ $json.body.instance }}",
        "messageId": "={{ $json.body.data.key.id }}"
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [-1344, -224],
      "id": "752840aa-d613-4d7b-a271-13d6dae9502c",
      "name": "Obter m dia em base64"
    },
    {
      "parameters": {
        "operation": "toBinary",
        "sourceProperty": "data.base64",
        "options": { "fileName": "audio.mp3" }
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [-1120, -224],
      "id": "12d4b85e-395c-47b7-8c69-0584d783eed2",
      "name": "Convert to File1"
    },
    {
      "parameters": {
        "workflowId": { "value": "1xCDK2DGnsJt4GD0" },
        "workflowInputs": {
          "value": {
            "mensaje": "={{ $json.final_message }}",
            "telefono": "={{ $json.sessionid }}",
            "fecha": "={{ $json.datetime }}",
            "instancia": "={{ $('Webhook').item.json.body.instance }}"
          }
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [208, -256],
      "id": "2c8fc319-1a4d-485b-a6c8-6140ed3415bd",
      "name": "Execute Workflow1"
    },
    {
      "parameters": {
        "jsCode": "function normalizar(s){return String(s).toLowerCase().trim();} return [{json:{ok:true}}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1520, 32],
      "id": "c6cdae31-4c66-4150-bf59-7b009f587dbf",
      "name": "calcularSimilitud1"
    },
    {
      "parameters": {
        "jsCode": "let mensaje = \"✅ He entendido tu pedido...\"; return [{json:{mensaje}}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1728, 32],
      "id": "8fc8fd67-f429-4be5-b818-31df39537081",
      "name": "armaMensaje"
    },
    {
      "parameters": {
        "resource": "messages-api",
        "instanceName": "={{ $('Webhook').first().json.body.instance }}",
        "remoteJid": "={{ $('Webhook').first().json.body.data.key.remoteJid }}",
        "messageText": "={{ $json.mensaje }}"
      },
      "type": "n8n-nodes-evolution-api.evolutionApi",
      "typeVersion": 1,
      "position": [1936, 32],
      "id": "6264a2af-74fa-407d-857e-2be7a9c10a2f",
      "name": "Enviar texto"
    },
    {
      "parameters": {
        "operation": "upsert",
        "table": "conversaciones",
        "key": "telefono",
        "value": "={{$json[\"body\"][\"data\"][\"key\"][\"remoteJid\"]}}",
        "fields": { "fase": "esperando_respuesta" }
      },
      "name": "Guardar estado esperando",
      "type": "n8n-nodes-base.datastore",
      "typeVersion": 1,
      "position": [2200, 200],
      "id": "guardar_estado"
    },
    {
      "parameters": {
        "functionCode": "const input = $json.body?.data?.message?.conversation?.trim().toLowerCase(); const sugerencias = $json.sugerencias || []; let seleccion=null; const matchNum=sugerencias.find(s=>String(s.opcion)===input); if(matchNum) seleccion=matchNum.producto; if(!seleccion){const matchTexto=sugerencias.find(s=>input.includes(s.producto.toLowerCase().split(\" \")[0])); if(matchTexto) seleccion=matchTexto.producto;} if(seleccion){return [{json:{mensaje:`✅ Perfecto, agregué: ${seleccion}`,producto_confirmado:seleccion,fase:\"inicio\"}}];} else {return [{json:{mensaje:\"⚠️ No entendí tu respuesta. Por favor responde con 1, 2 o 3.\"}}];}"
      },
      "name": "Function D interpretar respuesta",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [2200, 400],
      "id": "function_d"
    },
    {
      "parameters": {
        "operation": "upsert",
        "table": "conversaciones",
        "key": "telefono",
        "value":
